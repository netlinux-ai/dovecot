name: Build .deb package

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libssl-dev \
            libpam0g-dev \
            liblz4-dev \
            liblzma-dev \
            libzstd-dev \
            libbz2-dev \
            zlib1g-dev \
            libsqlite3-dev \
            libcap-dev \
            libwrap0-dev \
            libsystemd-dev \
            libexttextcat-dev \
            libsodium-dev \
            libicu-dev \
            libstemmer-dev \
            libunwind-dev \
            libtirpc-dev \
            pkg-config \
            checkinstall

      - name: Determine version
        id: version
        run: |
          UPSTREAM_VER="2.3.21.1"
          rev=${{ github.run_number }}
          echo "upstream=${UPSTREAM_VER}" >> "$GITHUB_OUTPUT"
          echo "version=${UPSTREAM_VER}-${rev}netlinux1" >> "$GITHUB_OUTPUT"
          echo "tag=v${UPSTREAM_VER}-${rev}netlinux1" >> "$GITHUB_OUTPUT"

      - name: Download and extract source
        run: |
          curl -sL -o dovecot.tar.gz \
            "https://dovecot.org/releases/2.3/dovecot-${{ steps.version.outputs.upstream }}.tar.gz"
          tar xzf dovecot.tar.gz
          mv dovecot-${{ steps.version.outputs.upstream }} dovecot-src

      - name: Build
        run: |
          cd dovecot-src
          CPPFLAGS="-I/usr/include/tirpc" \
          LDFLAGS="-ltirpc" \
          ./configure \
            --prefix=/usr \
            --sysconfdir=/etc \
            --localstatedir=/var \
            --libexecdir=/usr/lib/dovecot \
            --runstatedir=/run \
            --with-ssl=openssl \
            --with-pam \
            --with-sqlite \
            --with-icu \
            --with-stemmer \
            --with-sodium \
            --with-systemd \
            --with-lz4 \
            --with-zstd \
            --with-bzlib \
            --disable-static
          make -j$(nproc)

      - name: Package with checkinstall
        run: |
          cd dovecot-src
          sudo checkinstall --default \
            --pkgname=dovecot \
            --pkgversion="${{ steps.version.outputs.version }}" \
            --maintainer="graham@netlinux.co.uk" \
            --requires="libssl3t64,libpam0g,liblz4-1,liblzma5,libzstd1,libbz2-1.0,zlib1g,libsqlite3-0,libcap2,libwrap0,libsystemd0,libexttextcat-2.0-0,libsodium23,libicu74,libstemmer0d,libunwind8,libcrypt1,adduser,openssl" \
            --pakdir=.. \
            --install=no \
            --fstrans=no \
            make install

      - name: Repack .deb for reprepro compatibility
        run: |
          DEB=$(ls dovecot_*.deb)
          sudo chmod 666 "$DEB"
          mkdir repack && cd repack
          ar x "../$DEB"
          for f in *.zst; do
            [ -f "$f" ] || continue
            zstd -d "$f"
            xz "${f%.zst}"
            rm "$f"
          done
          rm "../$DEB"
          ar rcs "../$DEB" debian-binary control.tar.xz data.tar.xz

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: dovecot ${{ steps.version.outputs.version }}
          body: |
            Automated build from commit ${{ github.sha }}

            Dovecot ${{ steps.version.outputs.upstream }} IMAP server packaged for Debian/Ubuntu.
            Built with mbox, SSL, PAM, SQLite, ICU, lz4, zstd, and sodium support.

            Install: `sudo dpkg -i dovecot_*.deb`
          files: dovecot_*.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify package repository
        run: |
          sleep 5
          SIGNATURE=$(echo -n '{"repo":"netlinux-ai/dovecot","tag":"${{ steps.version.outputs.tag }}"}' \
            | openssl dgst -sha256 -hmac "${{ secrets.WEBHOOK_SECRET }}" -binary \
            | xxd -p -c 256)
          curl -sf -X POST \
            -H "Content-Type: application/json" \
            -H "X-Webhook-Signature: sha256=${SIGNATURE}" \
            -d '{"repo":"netlinux-ai/dovecot","tag":"${{ steps.version.outputs.tag }}"}' \
            https://packages.netlinux.co.uk/webhook/update-repo
